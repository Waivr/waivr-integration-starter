<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<div>
  <h2 class="product__title h1">Waivr Store</h2>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>

  <div>
    <fieldset>
      <legend>Pack</legend>

      <input type="radio" id="template--16166231802101__16559429068fc8f850-1-0" name="Pack" value="12 Pack" checked="">
      <label for="template--16166231802101__16559429068fc8f850-1-0">12 Pack</label>

      <input type="radio" id="template--16166231802101__16559429068fc8f850-1-1" name="Pack" value="24 Pack">
      <label for="template--16166231802101__16559429068fc8f850-1-1">24 Pack</label>

      <input type="radio" id="template--16166231802101__16559429068fc8f850-1-2" name="Pack" value="36 Pack">
      <label for="template--16166231802101__16559429068fc8f850-1-2">36 Pack</label>

    </fieldset>
    <fieldset>
      <legend>Flavor</legend>

      <input type="radio" id="template--16166231802101__16559429068fc8f850-2-0" name="Flavor" value="Variety Pack" checked="">
      <label for="template--16166231802101__16559429068fc8f850-2-0">Variety Pack</label>

      <input type="radio" id="template--16166231802101__16559429068fc8f850-2-1" name="Flavor" value="Mango Margarita">
      <label for="template--16166231802101__16559429068fc8f850-2-1">Mango Margarita</label>
    </fieldset>
  </div>

  <div>
    <label for="Quantity-template--16166231802101__16559429068fc8f850">Quantity</label>
    <input class="quantity__input" type="number" name="quantity" id="Quantity-template--16166231802101__16559429068fc8f850" min="1" value="1">
  </div>

  <div>
    <label>Frequency</label><br>
    <select required="" class="required" id="frequency" name="properties[Frequency]">
      <option value="2 Weeks">2 Weeks</option>
      <option value="4 Weeks">4 Weeks</option>
      <option value="8 Weeks">8 Weeks</option>
    </select>
  </div>

  <style>
    div.checkout {
      padding: 2%;
    }

    .sectionForm > div > h2
    {
      width: 500px;
    }

    .sectionForm > div.section
    {
      display: grid;
      grid-template-columns: [labels] 150px [controls] 1fr;
      grid-auto-flow: row;
      grid-gap: .8em;
      padding: 1.2em;
    }
    .sectionForm > div > label
    {
      grid-column: labels;
      grid-row: auto;
    }
    .sectionForm > div > input,
    .sectionForm > div > textarea,
    .sectionForm > div > select
    {
      grid-column: controls;
      grid-row: auto;
    }
    .sectionForm > button {
      grid-column: span 2;
    }
  </style>

  <div class="checkout">
    <div class="sectionForm">
      <div class="section">
        <h2>Shipping Address</h2>

        <label for="first-name">First Name*</label>
        <input required class="required" id="first-name" type="text" name="properties[_First Name]">

        <label for="last-name">Last Name*</label>
        <input required class="required" id="last-name" type="text" name="properties[_Last Name]">

        <label for="email">Email*</label>
        <input required class="required" id="email" type="email" name="properties[_Email]">

        <label for="shipping-address-line-1">Address Line 1 *</label>
        <textarea required class="required" id="shipping-address-line-1" name="properties[_Address Line 1]"></textarea>

        <label for="shipping-address-line-2">Address Line 2</label>
        <textarea id="shipping-address-line-2" name="properties[_Address Line 2]"></textarea>

        <label for="shipping-city">City*</label>
        <input id="shipping-city" type="text" name="properties[_City]">

        <label for="shipping-state">State*</label>
        <select id="shipping-state" name="properties[_State]">
          <option value="AL">Alabama</option>
          <option value="AK">Alaska</option>
          <option value="AZ">Arizona</option>
          <option value="AR">Arkansas</option>
          <option value="CA">California</option>
          <option value="CO">Colorado</option>
          <option value="CT">Connecticut</option>
          <option value="DE">Delaware</option>
          <option value="DC">District Of Columbia</option>
          <option value="FL">Florida</option>
          <option value="GA">Georgia</option>
          <option value="HI">Hawaii</option>
          <option value="ID">Idaho</option>
          <option value="IL">Illinois</option>
          <option value="IN">Indiana</option>
          <option value="IA">Iowa</option>
          <option value="KS">Kansas</option>
          <option value="KY">Kentucky</option>
          <option value="LA">Louisiana</option>
          <option value="ME">Maine</option>
          <option value="MD">Maryland</option>
          <option value="MA">Massachusetts</option>
          <option value="MI">Michigan</option>
          <option value="MN">Minnesota</option>
          <option value="MS">Mississippi</option>
          <option value="MO">Missouri</option>
          <option value="MT">Montana</option>
          <option value="NE">Nebraska</option>
          <option value="NV">Nevada</option>
          <option value="NH">New Hampshire</option>
          <option value="NJ">New Jersey</option>
          <option value="NM">New Mexico</option>
          <option value="NY">New York</option>
          <option value="NC">North Carolina</option>
          <option value="ND">North Dakota</option>
          <option value="OH">Ohio</option>
          <option value="OK">Oklahoma</option>
          <option value="OR">Oregon</option>
          <option value="PA">Pennsylvania</option>
          <option value="RI">Rhode Island</option>
          <option value="SC">South Carolina</option>
          <option value="SD">South Dakota</option>
          <option value="TN">Tennessee</option>
          <option value="TX">Texas</option>
          <option value="UT">Utah</option>
          <option value="VT">Vermont</option>
          <option value="VA">Virginia</option>
          <option value="WA">Washington</option>
          <option value="WV">West Virginia</option>
          <option value="WI">Wisconsin</option>
          <option value="WY">Wyoming</option>
        </select>

        <label for="shipping-country">Country</label>
        <span id="shipping-country">US</span>

        <label for="shipping-zip-code">Zip Code *</label>
        <input required class="required" id="shipping-zip-code" type="text" name="properties[_Zip Code]">
      </div>
    </div>
  </div>

  <div>
    <button id="link-button-again" class="button button--primary" data-initialized="true">Choose your Bank & Pay</button>
  </div>


  <script type="text/javascript">
    const allCookies = document.cookie;
    console.log("allCookies", allCookies);
    document.cookie = "username=John Doe";
    console.log("cookies", document.cookie);

    const shippingRecipient = $(".section-shipping-recipient");
    shippingRecipient.hide();

    const checkboxSameRecipient = $("#same-shipping-recipient");
    checkboxSameRecipient.prop('checked', true);

    checkboxSameRecipient.click(function( event ) {
      if($("#same-shipping-recipient").prop('checked')) {
        shippingRecipient.hide();
      } else {
        shippingRecipient.show();
      }
    });

    // This is Waiver production api
    const envUrl = "https://stage.waivr.co/api";

    // Upon registering your business you should have access to a UUID
    const merchantUid = "27305f40-6862-4e0a-9b51-81384dd7ab68";

    const authorizationHeader = "BT-EX-" + merchantUid + " 7VU0PefAGcmd7E8RxEZTgDZUJfoM7T4RLuUUEmuiqlNrJfu6Br";

    const headers = {
      "Content-Type": "application/json",
      "Authorization": authorizationHeader,
    };

    function setCookie(cName, cValue, expDays) {
        let date = new Date();
        date.setTime(date.getTime() + (expDays * 24 * 60 * 60 * 1000));
        const expires = "expires=" + date.toUTCString();
        document.cookie = cName + "=" + cValue + "; " + expires + "; path=/";
    }
    
    function getCookie(cName) {
      const name = cName + "=";
      const cDecoded = decodeURIComponent(document.cookie); //to be careful
      const cArr = cDecoded .split('; ');
      let res;
      cArr.forEach(val => {
          if (val.indexOf(name) === 0) res = val.substring(name.length);
      })
      return res;
    }

    setCookie('integration', "waivr", 30);

    // For institutions with OATH, it is required that we collect a redirect URL.
    // This URL must be provided to the payload and also informed to Waivr support team
    // prior to your production rollout.
    function pageRedirect() {
      window.location.href = "<your redirect URL>";
    }

    const getResponseBodyOrErrorOut = async (res, status) => {
      console.log("logging res", res);

      const body = await res.json();
      console.log("logging res", res);

      if (res.status === status) {
        return body;
      }

      const description = body && body.description;
      alert(description)
      throw new Error("Could not create process.", description);
    };

    const getShippingDetails = () => {
      return {
        line1 : $('#shipping-address-line-1').val(),
        line2 : $('#shipping-address-line-2').val() || null,
        city : $('#shipping-city').val(),
        state : $('#shipping-state').val(),
        country : "US",
        zipCode : $('#shipping-zip-code').val()
      };
    };

    const uidV4 = () => {
      let d = new Date().getTime();//Timestamp
      let d2 = (performance && performance.now && (performance.now() * 1000)) || 0;//Time in microseconds since page-load or 0 if unsupported
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random() * 16;//random number between 0 and 16
        if(d > 0){//Use timestamp until depleted
          r = (d + r)%16 | 0;
          d = Math.floor(d/16);
        } else {//Use microseconds since page-load if supported
          r = (d2 + r)%16 | 0;
          d2 = Math.floor(d2/16);
        }
        return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
      });
    }

    // ############################################################
    // From here onwards, this is how you integrate with Waivr
    // ############################################################

    // NOTE
    // Make sure to have already created a Business Partner in order to
    // proceed with the next steps


    // Create customer that you are onboarding during the checkout flow
    // It's ok if the customer has done it before, our API are idempotent.
    const createCustomer = async () => {
      const billingAddress = getShippingDetails();
      console.log("billingAddress", billingAddress)

      const payload = {
        merchantUid: merchantUid,
        email: $('#email').val(),
        firstName: $('#first-name').val(),
        lastName: $('#last-name').val(),
        address: { ...billingAddress }
      };

      console.log("payload", payload)

      const res = await fetch(envUrl + "/waivr-app/v1/customers", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: headers,
      });

      const data = await getResponseBodyOrErrorOut(res, 201);
      sessionStorage.setItem("customer", JSON.stringify(data));
      setCookie('customer', JSON.stringify(data), 30);

      return data;
    };

    // Now that you have created a customer profil in Waiver
    // You can request a link token to render Plaid for your customer
    // banking experience
    const createLinkToken = async () => {
      const res = await fetch(envUrl + "/waivr-app/v1/connectaccounts/render", {
        method: "POST",
        body: JSON.stringify({ merchantUid: merchantUid, redirectUrl: "https://localhost:8080" }),
        headers: headers,
      });

      const data = await getResponseBodyOrErrorOut(res, 201);
      return data.linkingAccessToken;
    };

    // Once you have finished with Plaid flow and collected the important information
    // about the customer's bank account, you must provide the bank account data
    // to Waivr so we can manage the payment instructions
    const connectAccount = async (customer, publicToken, metadata) => {
      console.log('Connecting account with publicToken', publicToken, metadata);
      await fetch(envUrl + "/waivr-app/v1/connectaccounts/connect", {
        method: "POST",
        body: JSON.stringify({
          merchantUid: merchantUid,
          customerUid: customer.uid,
          institution: {
            identifier: metadata.institution.institution_id,
            accountIdentifier: metadata.account_id
          },
          publicToken: publicToken
        }),
        headers: headers,
      });
    }

    // This is how to prepare Plaid's screen and callback in order to provide the customer's bank account
    // to Waivr
    const connectBankAccount = async (customer, linkingAccessToken, postBankConnected) => {
      console.log('Calling plaid with linkingAccessToken', linkingAccessToken);
      Plaid.create({
        token: linkingAccessToken,
        onSuccess: async (publicToken, metadata) => {
          connectAccount(customer, publicToken, metadata);
          setTimeout(
                  function() {
                    postBankConnected(customer);
                  }, 2000
          );
        },
        onEvent: (eventName, metadata) => {
        },
        onExit: (error, metadata) => {
        },
      }).open();
    };

    // Now that you have already onboarded the customer and linked their bank account
    // the next step is to create the payment instructions that define how Waivr should
    // handle payments
    const createPaymentInstruction = async (customer) => {
      const productPrice = 12;

      const productSize = $('input[name="Pack"]:checked').val();

      const productName = $('input[name="Flavor"]:checked').val();

      const productQuantity = $('input[name="quantity"]').val();

      const totalSubscription = productPrice * productQuantity;

      const frequency = $('#frequency').find(":selected").text().split(' ');
      const frequencyRecurrence = frequency[0];

      let frequencyCycle;
      switch (frequency[1]) {
        case 'Weeks':
          frequencyCycle = 'WEEKLY';
          break;
      }

      const payload = {
        externalReferenceIdentifier: uidV4(), // this information should be your Order ID or Tracking Number.
        customerUid: customer.uid,
        merchantUid: merchantUid,
        amount: totalSubscription,
        frequency: {
          recurrence: frequencyRecurrence,
          cycle: frequencyCycle
        },
        metadata: {
          shippingDetails: {
            personName: {
              firstName: $('#first-name').val(),
              lastName: $('#last-name').val()
            },
            address: getShippingDetails()
          },
          orderDetails: {
            product: {
              name: productName,
              size: productSize
            },
            quantity: productQuantity
          }
        }
      };

      const res = await fetch(envUrl + "/waivr-app/v1/paymentinstructions", {
        method: "POST",
        body: JSON.stringify(payload),
        headers: headers,
      });

      const data = await getResponseBodyOrErrorOut(res, 201);
      console.log("payment instruction", data)
      sessionStorage.setItem("paymentInstruction", JSON.stringify(data));
      document.cookie += "paymentInstruction" + JSON.stringify(data);
      return data;
    };

    // Before a payment ought to be collected, it's a good practice to share the summary of the checkout flow
    // The API below will consolidate all important information about the Payment Instructions and Bank account linked
    // with the system.
    const getPaymentInstructionSummary = async (paymentInstruction) => {
      const res = await fetch(envUrl + "/waivr-app/v1/paymentinstructions/" + paymentInstruction.uid + "/summary", {
        method: "GET",
        headers: headers,
      });

      const data = await getResponseBodyOrErrorOut(res, 200);
      console.log("paymentInstructionSummary", data)

      // This is an option on how to transit from this html to the confirmation page html
      sessionStorage.setItem("paymentInstructionSummary", JSON.stringify(data));
      document.cookie += "paymentInstructionSummary" + JSON.stringify(data);

      return data;
    };

    // ##################################################################################################
    // From here onwards, this is how you orchestrate the calls to create a payment instruction
    // ##################################################################################################

    const postBankConnected = async (customer) => {
      console.log("Post Bank Account")
      const paymentInstruction = await createPaymentInstruction(customer);
      await getPaymentInstructionSummary(paymentInstruction);
      // pageRedirect();
    };

    (async ($) => {
      const runPlaid = async () => {
        const customer = await createCustomer();
        const linkingAccessToken = await createLinkToken();
        await connectBankAccount(customer, linkingAccessToken, postBankConnected);
      }

      $('#link-button-again').on('click', function(e) { runPlaid() });
    })(jQuery);
  </script>

</div>

</body>
</html>
